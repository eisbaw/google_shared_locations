var request = require('request');
var Sync = require('sync');

var Result = require('./Result');
var Errors = require('./Errors');

var Soap = function(connection_settings) {
    this.connection_settings = connection_settings;
}

Soap.prototype.communicate = function(request_xml, h) {
    //console.log('Soap.prototype.communicate');
    var self = this;

    var ret = new Result(h, arguments, 'Soap.prototype.communicate');

    /* в связи с тем, что такие ошибки как:
     { [Error: socket hang up] code: 'ECONNRESET' }
     не отлавливаются обычным образом, предложено следующее решение --->
     */
    Sync(function(){
        if(!request_xml){
            throw(Errors.soap.empty_request);
        }

        var conn = self.connection_settings;
        conn.body = request_xml;

        var r = request.post.sync(request.post, conn);
        if(200 != r[0].statusCode) {
            throw('Статус: '+r[0].statusCode);
        }

        return r[1];
    }, ret.checkError(Errors.soap.communication));
}

module.exports = Soap;